<!DOCTYPE html>
<!-- 新建资讯对话框  -->
<html lang="zh">
<head>
<meta charset="UTF-8">
<style>
	input {
		width: 466px;
	}
</style>
</head>
<body>
	<div id="dialog_body" >	
		<form action="" method="post" id="form" enctype="application/x-www-form-urlencoded">
			<fieldset>
				<p>
					<label>主题</label><input id="theme" name="" type="text" required maxlength="16" value="少于16个字" />
				</p>
				<p>
					<label>标签</label><select><option>请选择</option><option>体育</option><option>娱乐</option></select>
				</p>
				<p id="snapshot1">
					<label>活动配图</label><button class="upload">上传</button><label class="supported">(支持的图片类型：jpg, png, gif, bmp)</label><input type="file" id="pic"/>
				</p>
				<p id="snapshot2">
					<label class="top">活动配图</label><img src="" width="220" height="120" id="originPic"/>
					 <span id="preview" style="float: right; margin-right: 100px;width: 110px; height: 110px; overflow: hidden;"><img src="" style="width: 110px; height: 110px;" id="final" /></span>
					<button class="save" style="margin-left: 100px;">保存</button><button class="delete">删除</button>
					<input type="hidden" name="x1" value="" />
					<input type="hidden" name="y1" value="" />
					<input type="hidden" name="x2" value="" />
					<input type="hidden" name="y2" value="" />
				</p>
				<p id="snapshot3">
					<label class="top">活动配图</label><img src="" width="110" height="110" id="final2" /><a href="" id="changeImg">更改图片</a>
				</p>
				<p>
					<label class="top">正文</label><textarea required>正文</textarea>
				</p>
				<p>
					<button class="cancel">取消</button><input type="submit" value="发布" />
				</p>
			</fieldset>
		</form>
	</div>
</body>
<script>

var scaleX,scaleY,x1,y1;

function openFilePickDialog() {
	$('#dialog-form .upload').click(function(event) {
		event.preventDefault();
		$('#pic').click();
	});
}

function changeImg() {
	$('#changeImg').click(function(event) {
		event.preventDefault();
		$('#snapshot1').show();
		$('#snapshot2').hide();
		$('#snapshot3').hide();
	});
}
function save() {
	$('.save').click(function(event) {
		
		event.preventDefault();
		$('#snapshot2').hide();
		$('#snapshot3').show();
		
	    $('#final2').css({
	        width: Math.round(scaleX * 220),		/* 206 - 110 */
	        height: Math.round(scaleY * 120),		/* 123 - 110 */
	        marginLeft: -Math.round(scaleX * selection.x1),
	        marginTop: -Math.round(scaleY * selection.y1)
	    });
	});
}

function del() {
	$('.delete').click(function(event) {
		event.preventDefault();
		$('#snapshot1').show();
		$('#snapshot2').hide();
	});
}

function preview(img, selection) {
    if (!selection.width || !selection.height)
        return;
    
    var scaleX = 100 / selection.width;
    var scaleY = 100 / selection.height;

    $('#preview img').css({
        width: Math.round(scaleX * 220),		/* 206 - 110 */
        height: Math.round(scaleY * 120),		/* 123 - 110 */
        marginLeft: -Math.round(scaleX * selection.x1),
        marginTop: -Math.round(scaleY * selection.y1)
    });

}
function pickImg() {
	$("#pic").change(function(){
	    if (this.files && this.files[0]) {
	        var reader = new FileReader();
	        reader.onload = function (e) {
	            $('#originPic').attr('src', e.target.result);
	            $('#final').attr('src',e.target.result);
	            $('#final2').attr('src',e.target.result);
	        };
	        reader.readAsDataURL(this.files[0]);
	    }
	    $('#snapshot1').hide();
	    $('#snapshot2').show();
	    
		$('#originPic').imgAreaSelect({
			aspectRatio: '1:1',
	        handles: true,
	        maxHeight:  110,
	        maxWidth: 110,
	        onSelectChange: preview,
	        onSelectEnd: function (img, selection) {
	            $('input[name="x1"]').val(selection.x1);
	            $('input[name="y1"]').val(selection.y1);
	            $('input[name="x2"]').val(selection.x2);
	            $('input[name="y2"]').val(selection.y2); 
	            x1 = selection.x1;
	            y1 = selection.y1;
	            scaleX = 100 / selection.width;
	            scaleY = 100 / selection.height;
	        }
	    });
	});
}
	$(function() {
		// hide snapshot2,3
		$('#snapshot2').hide();
		$('#snapshot3').hide();
		changeImg();
		save();
		del();
		close();
		testAddNewsfeed();
		confirmDelete();
		clearPhoneHint();
		openFilePickDialog();
		pickImg();
		$('#form').validate();
	});
</script>
</html>